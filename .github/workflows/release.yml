name: Build and Release
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main  # Triggers on push to main branch
    # The job will only run if the commit message contains the keyword '[run-ci]'
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab

env:
  CARGO_TERM_COLOR: always
  RUSTC_WRAPPER: sccache
  SCCACHE_DIR: C:\Users\runneradmin\.cache\sccache
  SCCACHE_IDLE_TIMEOUT: 0

jobs:
  build-and-release:
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && contains(github.event.head_commit.message, '[run-ci]'))
    runs-on: windows-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Node.js modules
        uses: actions/cache@v4
        with:
          path: repak-x/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('repak-x/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Frontend Dependencies
        working-directory: repak-x
        run: npm install

      - name: Cache Cargo Registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Rust Build (target folder)
        uses: actions/cache@v4
        with:
          path: target/
          key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock', 'Cargo.toml', 'repak-x/tauri.conf.json', 'repak-x/package.json') }}-${{ hashFiles('**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock', 'Cargo.toml', 'repak-x/tauri.conf.json', 'repak-x/package.json') }}-
            ${{ runner.os }}-cargo-target-

      - name: Install sccache
        uses: mozilla-actions/sccache-action@v0.0.4

      - name: Cache sccache
        uses: actions/cache@v4
        with:
          path: C:\Users\runneradmin\.cache\sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-sccache-

      - name: Start sccache server
        shell: pwsh
        run: |
          sccache --start-server
          sccache --show-stats

      - name: Read Version
        id: version
        shell: pwsh
        run: |
          $cargoContent = Get-Content -Path "Cargo.toml" -Raw
          $version = [regex]::Match($cargoContent, '(?m)^version\s*=\s*"([^"]+)"').Groups[1].Value
          Write-Host "Version: $version" -ForegroundColor Green
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT

      - name: Create Distribution Package (ZIP Only)
        id: package
        shell: pwsh
        run: |
          Write-Host "Creating ZIP distribution package..." -ForegroundColor Cyan
          .\build_and_package.ps1 -Configuration release -Zip
          
          $version = "${{ steps.version.outputs.VERSION }}"
          $zipPath = "dist\Repak-X-v$version.zip"
          
          if (Test-Path $zipPath) {
            $zipSize = [math]::Round((Get-Item $zipPath).Length / 1MB, 2)
            Write-Host "ZIP created: $zipSize MB" -ForegroundColor Green
            echo "ZIP_PATH=$zipPath" >> $env:GITHUB_OUTPUT
            echo "ZIP_SIZE=$zipSize" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "ERROR: ZIP file not found!" -ForegroundColor Red
            exit 1
          }

      - name: Create and Push Tag
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag "v$version"
          git push origin "v$version"

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Repak X v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: false
          files: ${{ steps.package.outputs.ZIP_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Discord
        if: success()
        shell: pwsh
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          
          if (-not $env:DISCORD_WEBHOOK) {
            Write-Host "Discord webhook not configured, skipping notification" -ForegroundColor Yellow
            exit 0
          }
          
          Write-Host "Sending Discord notification..." -ForegroundColor Cyan
          
          $payload = @{
            content = "<@&1472639362557542510> <:RepakXApp:1448417099318956133> **Repak X v$version** is now available!`nhttps://github.com/XzantGaming/Repak-X/releases/latest"
          } | ConvertTo-Json -Depth 5
          
          try {
            Invoke-RestMethod -Uri $env:DISCORD_WEBHOOK -Method Post -Body $payload -ContentType 'application/json'
            Write-Host "Discord notification sent successfully!" -ForegroundColor Green
          } catch {
            Write-Host "Failed to notify Discord: $($_.Exception.Message)" -ForegroundColor Red
          }

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: repak-x-v${{ steps.version.outputs.VERSION }}
          path: ${{ steps.package.outputs.ZIP_PATH }}
          retention-days: 30

      - name: Stop sccache and show stats
        if: always()
        shell: pwsh
        run: |
          sccache --show-stats 2>$null
          sccache --stop-server 2>$null
          exit 0
